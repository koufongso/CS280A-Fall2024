<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <title>CS280A Fall2024 Project 1</title>
</head>

<body>
    <nav class="navbar"
        style="--bs-navbar-brand-hover-color: white; --bs-navbar-brand-color: white; background-color: #003262;">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 fs-4 fw-bold">UC Berkeley CS280A: Intro to Computer Vision and Computational
                Photography
                (Fall2024)</span>
        </div>
    </nav>

    <br>
    <div class="container-fluid content">
        <div class="row">
            <div class="col-2">
                <div class="sticky-top">
                    <ul class="nav flex-column fs-5">
                        <li class="nav-item">
                            <a class="nav-link" href="#project1">Project 1</a>
                            <ul class="nav flex-column fs-6" style="margin-left: 30px;">
                                <li class="nav-item"><a class="nav-link" href="#project1">Background</a>
                                </li>
                                <li class="nav-item"><a class="nav-link" href="#implementation">Implementation</a></li>
                                <li class="nav-item"><a class="nav-link" href="#result">Result</a></li>
                                <li class="nav-item"><a class="nav-link" href="#improvement">Improvement</a></li>
                            </ul>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">Project 2</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">Project 3</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">Project 4</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">Project 5</a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="col-9 content">
                <div id="project1">
                    <h1>Project 1: Colorizing the Prokudin-Gorskii photo collection</h1>
                </div>
                <br>
                <div>
                    <h2 id="background">1. Background</h2>
                    <p>Sergei Mikhailovich Prokudin-Gorskii's photo collection consists of images where three separate
                        exposures of a scene were captured on a glass plate using red, green, and blue filters. To
                        produce high-quality colorized photos, a significant challenge is to properly align these three
                        color channels. The objective of this project is to develop a method for accurately aligning the
                        photos from the three channels to create a coherent, high-quality color image.
                    </p>

                    <div class="row">
                        <div class="col">
                            <figure>
                                <img src="./images/cathedral.jpg">
                                <figcaption>Original photos, photot from top to bottom correspond to blue, green and red
                                    channel.</figcaption>
                            </figure>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <figure>
                                <img src="./images_colorized/cathedral_c_no_align.jpg">
                                <figcaption>Colorized photo with no alignment.</figcaption>
                            </figure>
                        </div>
                    </div>

                    <h2 id="implementation">2. Implementation</h2>
                    <h3>2.1 Single Scale</h3>
                    <p>One proposed pipeline is shown as follows:</p>

                    <div class="row">
                        <div class="col">
                            <figure class="row">
                                <img src="./doc/pipeline.png">
                            </figure>
                        </div>
                    </div>

                    <p>The main work here is to develop the <b>Find alignment</b> method. The rest part were implemented
                        as follows:
                    <ul>
                        <li><b>Crop photo</b>: For now it simply cut the photos at its 1/3 and 2/3 height.</li>
                        <li><b>Align photos</b>: I used OpenCV's <code>warpAffine</code> function to shift the images by
                            the estimated
                            displacement.</li>
                        <li><b>Map to color</b>:I used <code>numpy.dstack</code> to stack the three channel's pixel
                            value to colorize the photos.</li>
                    </ul>

                    <p>To find the optimal photo alignment, the simplest method is to use a brute-force search within an
                        alignment window (e.g., [-15, 15] pixels around the initial alignment value). The goal is to
                        find the alignment that results in the minimum value from a defined cost function. In this
                        project, I used the Euclidean distance between the two images as the cost function.</p>

                    <p>Before computing the cost, two preprocessing steps are necessary:</p>
                    <ul>
                        <li><b>Photo binarization</b>: I experimented with several
                            methods and found that converting the images to black and
                            white improves the alignment results. This is likely because black and white conversion
                            helps to remove noise and simplifies the image by focusing on areas with strong
                            contrast. I used a threshold of 0.5 for one fixed channel (e.g., the green channel
                            photo) and computed the threshold for the other photo based on their mean pixel value
                            ratio. While more sophisticated binarization methods, such as the Otsu method [<a
                                href="https://docs.opencv.org/4.x/d7/d4d/tutorial_py_thresholding.html"
                                target="_blank">reference</a>],are available, this approach was easier to implement
                            and sufficient for the current project.
                            but this is easy to implement by myself and sufficient enough for current project.</li>
                        <li><b>Remove photo margins</b>: The black and white borders of the photos can affect the cost
                            function and reduce alignment quality. To mitigate this, I computed the overlap region of
                            the two images using only 2/3 of the input image, excluding the margins. This also reduces
                            the number of compared pixels and speeds up the process.</li>
                    </ul>

                    <h3>2.2 Multi-scale Pyramid</h3>
                    <p>For high-resolution photos, brute-force search is time-consuming; therefore, I adopted the
                        multi-scale pyramid method. The pipeline is shown as follows:</p>
                    <div class="row">
                        <div class="col">
                            <figure class="row">
                                <img src="./doc/pipeline_multiscale.png">
                            </figure>
                        </div>
                    </div>

                    <p>There are two new elements:
                        <li><b>Generate multi-scale pyramid</b>: I generated the pyramid by halving the photo resolution
                            using OpenCV's <code>resize</code> method (a larger N value means the image is coarser.).
                            Note that while the user can specify the maximum
                            scale of the pyramid, experiments indicated that overly downsampled photos can harm the
                            alignment result. Therefore, this method should prevent resizing photos below a certain
                            threshold. </li>
                        <li><b>(New) Find alignment</b>: This new method is a modification of the original one, making
                            it a recursive function. After reaching the original photo scale, it outputs the estimated
                            alignment as the final estimated alignment.</li>

                    </p>s

                    <h3>2.3 Pseudocode</h3>
                    <p>Below is the pseudocode for finding image alignment, including both single-scale and multi-scale
                        approaches, as well as the image pyramid method. You can find the python implementation <a
                            href="https://github.com/koufongso/CS280A-Fall2024" target="_blank">here</a>.</p>

                    <pre>
                        <code>
                            function findAlignmentSingleScale(image1, image2, initial_dx, initial_dy, search_window):
                                // normalize images
                                image1 <- normalize(image1)
                                image2 <- normalize(image2)
                                
                                // set binarization threshold
                                threshold2 <- 0.5
                                threshold1 <- threshold2 * (mean(image1) / mean(image2))

                                // binarize images
                                image1 <- binarization(image1, threshold1)
                                image2 <- binarization(image2, threshold2)
                                
                                // brute-force serach 
                                best_dx <- dx
                                bext_dy <- dy
                                best_cost <- M
                                for dx in initial_dx+search_window
                                    for dy in initial_dy+search_window
                                        image1, image2 <- find_overlap_region(image1, image2, dx, dy)
                                        image1, image2 <- remove_margin(image1, image2, margin_offset)
                                        cost <- Euclidean_distance(image1,image2)
                                        if cost < best_cost
                                            best_dx <- dx
                                            best_dy <- dy

                                return best_dx, best_dy
                        </code>

                        <code>
                            function findAlignmentMultiScale(pyramid1, pyramid2, scale, initial_dx, initial_dy, search_window):
                                // recursion guard
                                if scale < 0:
                                    return initial_dx, initial_dy
                                
                                // retrive images at the current scale from the pyramids
                                image1 <- pyramid1[scale]
                                image2 <- pyramid2[scale]
                                
                                // find best alignment at the current scale 
                                best_dx, best_dy <- findAlignmentSingleScale(image1, image2, initial_dx, initial_dy, search_window)

                                // recursive call for the next scale (higher resolution) 
                                scale <- scale-1
                                return findAlignmentMultiScale(pyramid1,pyramid2,scale, best_dx, best_dy, search_window)
                        </code>

                        <code>
                            function createImagePyramid(image, max_scale):
                                pyramid <- Empty List
                                // Compute the mathematically available maximum scale
                                max_scale <- min(log2(image_width), log2(image_height), max_scale)
                            
                                for scale in range(max_scale):
                                    // Compute new image size
                                    new_width <- image_width / pow(2, scale)
                                    new_height <- image_height / pow(2, scale)
                                    
                                    // Prevent overly downsampled image
                                    if new_width < size_threshold or new_height < size_threshold:
                                        return pyramid
                            
                                    // Resize image to new dimensions
                                    new_image <- resize_image(image, new_width, new_height)
                                    pyramid.add(new_image)
                            
                                return pyramid
                        </code>
                    </pre>


                    <h2 id="result">Result</h2>
                    <h4>Low resolution images</h4>
                    <!-- low res image-->
                    <div class="row">
                        <div class="col">
                            <figure class="figure">
                                <img src="./images_colorized/cathedral_c.jpg" class="img-fluid" alt="...">
                                <figcaption class="figure-caption text-center fs-6">
                                    <a href="https://www.loc.gov/item/2018679961/" target="_blank">General view of
                                        the
                                        [Nikolaevskii] cathedral from southwest. Mozhaisk
                                    </a>
                                </figcaption>
                            </figure>
                        </div>
                        <!---->
                        <div class="col">
                            <figure class="figure">
                                <img src="./images_colorized/monastery_c.jpg" class="img-fluid" alt="...">
                                <figcaption class="figure-caption text-center fs-6">
                                    <a href="https://www.loc.gov/item/2018681345/" target="_blank">View of the
                                        monastery
                                        from Svetlitsa[Island, Saint Nil Stolbenskii Monastery, Lake Seliger]
                                    </a>
                                </figcaption>
                            </figure>
                        </div>
                        <!---->
                        <div class="col">
                            <figure class="figure">
                                <img src="./images_colorized/tobolsk_c.jpg" class="img-fluid" alt="...">
                                <figcaption class="figure-caption text-center fs-6">
                                    <a href="https://www.loc.gov/item/2018681091/" target="_blank">View of the city
                                        of
                                        Tobolsk from the
                                        north, from the bell tower of the Church of the Transfiguration
                                    </a>
                                </figcaption>
                            </figure>
                        </div>
                    </div>
                    <br>

                    <!-- high res image-->
                    <h4>High resolution images</h4>
                    <div class="row">
                        <div class="col">
                            <figure class="figure">
                                <img src="./images_colorized/church_c.jpg" class="img-fluid" alt="...">
                                <figcaption class="figure-caption text-center fs-6">
                                    <a href="https://www.loc.gov/item/2018678818/" target="_blank">[Epiphany church
                                        in
                                        the village of Ust-Boiarskoe, Olonets Province]
                                    </a>
                                </figcaption>
                            </figure>
                        </div>
                        <!---->
                        <div class="col">
                            <figure class="figure">
                                <img src="./images_colorized/emir_c.jpg" class="img-fluid" alt="...">
                                <figcaption class="figure-caption text-center fs-6">
                                    <a href="https://www.loc.gov/item/2018680327/" target="_blank">Emir of Bukhara.
                                        Bukhara
                                    </a>
                                </figcaption>
                            </figure>
                        </div>
                        <!---->
                        <div class="col">
                            <figure class="figure">
                                <img src="./images_colorized/harvesters_c.jpg" class="img-fluid" alt="...">
                                <figcaption class="figure-caption text-center fs-6">
                                    <a href="https://www.loc.gov/item/2018679759/" target="_blank">Group of workers
                                        harvesting tea. Greek women. [Chakva]
                                    </a>
                                </figcaption>
                            </figure>
                        </div>
                    </div>
                    <br>

                    <div class="row">
                        <div class="col">
                            <figure class="figure">
                                <img src="./images_colorized/icon_c.jpg" class="img-fluid" alt="...">
                                <figcaption class="figure-caption text-center fs-6">
                                    <a href="https://www.loc.gov/item/2018680022/" target="_blank">Miraculous icon
                                        of
                                        Mother of God-Odigitria in the Church of the Assumption of the Virgin.
                                        [Smolensk]
                                    </a>
                                </figcaption>
                            </figure>
                        </div>
                        <!---->
                        <div class="col">
                            <figure class="figure">
                                <img src="./images_colorized/lady_c.jpg" class="img-fluid" alt="...">
                                <figcaption class="figure-caption text-center fs-6">
                                    <a href="https://www.loc.gov/item/2018679082/" target="_blank">Head study
                                    </a>
                                </figcaption>
                            </figure>
                        </div>
                        <!---->
                        <div class="col">
                            <figure class="figure">
                                <img src="./images_colorized/melons_c.jpg" class="img-fluid" alt="...">
                                <figcaption class="figure-caption text-center fs-6">
                                    <a href="https://www.loc.gov/item/2018680241/" target="_blank">Melon vendor.
                                        Samarkand
                                    </a>
                                </figcaption>
                            </figure>
                        </div>
                    </div>

                    <br>
                    <div class="row">
                        <div class="col">
                            <figure class="figure">
                                <img src="./images_colorized/onion_church_c.jpg" class="img-fluid" alt="...">
                                <figcaption class="figure-caption text-center fs-6">
                                    <a href="https://www.loc.gov/item/2018680634/" target="_blank">Church of the
                                        Resurrection in the Grove (from the other side). [Kostroma]
                                    </a>
                                </figcaption>
                            </figure>
                        </div>
                        <!---->
                        <div class="col">
                            <figure class="figure">
                                <img src="./images_colorized/sculpture_c.jpg" class="img-fluid" alt="...">
                                <figcaption class="figure-caption text-center fs-6">
                                    <a href="https://www.loc.gov/item/2018679062/" target="_blank">In Alupka. Crimea
                                    </a>
                                </figcaption>
                            </figure>
                        </div>
                        <!---->
                        <div class="col">
                            <figure class="figure">
                                <img src="./images_colorized/self_portrait_c.jpg" class="img-fluid" alt="...">
                                <figcaption class="figure-caption text-center fs-6">
                                    <a href="https://www.loc.gov/item/2018679724/" target="_blank">[On the
                                        Skuritskhali
                                        River. Study, Orto-Batum village]
                                    </a>
                                </figcaption>
                            </figure>
                        </div>
                    </div>

                    <br>
                    <div class="row">
                        <div class="col">
                            <figure class="figure">
                                <img src="./images_colorized/three_generations_c.jpg" class="img-fluid" alt="...">
                                <figcaption class="figure-caption text-center fs-6">
                                    <a href="https://www.loc.gov/item/2018679520/" target="_blank">Three
                                        generations.
                                        A.P. Kalganov with son and granddaughter. The last two work in the shops
                                        of the Zlatoust plant
                                    </a>
                                </figcaption>
                            </figure>
                        </div>
                        <!---->
                        <div class="col">
                            <figure class="figure">
                                <img src="./images_colorized/train_c.jpg" class="img-fluid" alt="...">
                                <figcaption class="figure-caption text-center fs-6">
                                    <a href="https://www.loc.gov/item/2018679302/" target="_blank">Steam engine
                                        "Kompaund" with a Schmidt super-heater
                                    </a>
                                </figcaption>
                            </figure>
                        </div>
                        <!---->
                        <div class="col">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <br>
    <nav class="navbar"
        style="--bs-navbar-brand-hover-color: white; --bs-navbar-brand-color: white; background-color: #003262;">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 fs-4 fw-bold"> </span>
        </div>
    </nav>


</body>

</html>